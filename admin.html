<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ALM • Data Card Admin</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet"/>
<style>
:root{--primary:#0A3D62;--accent:#DC2626;--ink:#1A202C;--muted:#64748b;--light:#F4F7F9;--border:#e5e7eb}
*{box-sizing:border-box}body{margin:0;font-family:'Roboto',sans-serif;background:#fff;color:var(--ink)}
h1,h2{font-family:'Montserrat',sans-serif;color:var(--primary)}
.wrap{max-width:1200px;margin:0 auto;padding:24px}
.toolbar{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 16px}
.btn{background:var(--primary);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;text-decoration:none;display:inline-block}
.btn.red{background:var(--accent)}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid var(--border);vertical-align:top}
th{font-family:'Montserrat',sans-serif;text-align:left}
input,textarea{width:100%;padding:8px;border:1px solid var(--border);border-radius:8px}
small{color:var(--muted)}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:900px){.row{grid-template-columns:1fr}}
.code{background:#0b1220;color:#e2e8f0;padding:10px;border-radius:8px;overflow:auto;font-family:ui-monospace,Menlo,monospace}
</style>
</head>
<body>
<div class="wrap">
  <h1>Data Card Admin</h1>
  <p>Edits here update a JSON preview. Click <b>Download JSON</b> and commit <code>data/datacards.json</code> to publish.</p>

  <div class="toolbar">
    <button class="btn" id="add">Add Card</button>
    <button class="btn" id="download">Download JSON</button>
    <a class="btn red" target="_blank" href="https://github.com/jmobrien1/ALM/edit/main/data/datacards.json">Open GitHub Web Editor</a>
  </div>

  <table id="tbl">
    <thead>
      <tr><th style="width:140px">ID</th><th>Title</th><th style="width:160px">Universe</th><th style="width:140px">Base $/M</th><th style="width:160px">Updated</th><th style="width:140px">Actions</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Selected Card</h2>
  <div id="detail">
    <div class="row">
      <div><label>Title<input id="f_title"/></label></div>
      <div><label>Short Description<input id="f_short"/></label></div>
    </div>
    <div class="row">
      <div><label>Universe<input id="f_universe" type="number"/></label></div>
      <div><label>Base Rate ($/M)<input id="f_base" type="number" step="0.01"/></label></div>
    </div>
    <div class="row">
      <div><label>Last Updated<input id="f_updated" placeholder="YYYY-MM-DD"/></label></div>
      <div><label>PDF (optional path)<input id="f_pdf" placeholder="assets/pdfs/Example.pdf"/></label></div>
    </div>
    <label>Description<textarea id="f_desc" rows="5"></textarea></label>

    <h3>Pricing</h3>
    <div id="pricing"></div>
    <button class="btn" id="addPrice">+ Add Price Row</button>

    <h3 style="margin-top:16px">Selects</h3>
    <div id="selects"></div>
    <button class="btn" id="addSelect">+ Add Select</button>
  </div>

  <h2>JSON Preview</h2>
  <pre class="code" id="json"></pre>
</div>

<script>
let cards=[], current=null;
const el=(s,d=document)=>d.querySelector(s);

function renderTable(){
  const tb=el('#tbl tbody'); tb.innerHTML='';
  cards.sort((a,b)=>a.title.localeCompare(b.title)).forEach(c=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${c.id}</td>
      <td>${c.title}</td>
      <td>${(c.universe||0).toLocaleString()}</td>
      <td>$${(+c.baseRate||0).toFixed(2)}</td>
      <td>${c.lastUpdate||''}</td>
      <td>
        <a href="#" data-id="${c.id}" class="edit">Edit</a> •
        <a href="#" data-id="${c.id}" class="del">Delete</a> •
        <a href="datacard.html?id=${c.id}" target="_blank">View</a>
      </td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('.edit').forEach(a=>a.onclick=e=>{e.preventDefault(); select(+a.dataset.id);});
  tb.querySelectorAll('.del').forEach(a=>a.onclick=e=>{
    e.preventDefault(); if(confirm('Delete this card?')){
      cards = cards.filter(x=>x.id!=+a.dataset.id);
      if(current && current.id==+a.dataset.id) current=null;
      renderTable(); dumpJSON();
    }
  });
  dumpJSON();
}

function select(id){
  current = cards.find(x=>x.id==id); if(!current) return;
  const bind=(id,prop)=>{ const i=el('#'+id); i.value=current[prop]??''; i.oninput=()=>{ current[prop]=i.type==='number'? +i.value : i.value; dumpJSON(); renderTable(); };};
  bind('f_title','title'); bind('f_short','shortDescription'); bind('f_universe','universe');
  bind('f_base','baseRate'); bind('f_updated','lastUpdate'); bind('f_pdf','pdf');
  const desc=el('#f_desc'); desc.value=current.description||''; desc.oninput=()=>{current.description=desc.value; dumpJSON();};

  // pricing
  const p=el('#pricing'); p.innerHTML='';
  (current.pricing||[]).forEach((row,i)=>{
    const d=document.createElement('div'); d.className='row';
    d.innerHTML=`
      <div><label>Segment<input value="${row.segment||''}"></label></div>
      <div><label>Count<input type="number" value="${row.count||0}"></label></div>
      <div><label>$/M<input type="number" step="0.01" value="${row.price||0}"></label></div>
      <div><button class="btn red">Delete</button></div>`;
    const [seg,cnt,price,del]=d.querySelectorAll('input,button');
    seg.oninput=()=>{row.segment=seg.value; dumpJSON();};
    cnt.oninput=()=>{row.count=+cnt.value; dumpJSON();};
    price.oninput=()=>{row.price=+price.value; dumpJSON();};
    del.onclick=()=>{ current.pricing.splice(i,1); renderTable(); select(current.id); };
    p.appendChild(d);
  });
  el('#addPrice').onclick=()=>{ (current.pricing ||= []).push({segment:'',count:0,price:0}); renderTable(); select(current.id); };

  // selects
  const s=el('#selects'); s.innerHTML='';
  (current.selects||[]).forEach((row,i)=>{
    const d=document.createElement('div'); d.className='row';
    d.innerHTML=`
      <div><label>Select<input value="${row.name||''}"></label></div>
      <div><label>$/M<input type="number" step="0.01" value="${row.price||0}"></label></div>
      <div><button class="btn red">Delete</button></div>`;
    const [name,price,del]=d.querySelectorAll('input,button');
    name.oninput=()=>{row.name=name.value; dumpJSON();};
    price.oninput=()=>{row.price=+price.value; dumpJSON();};
    del.onclick=()=>{ current.selects.splice(i,1); renderTable(); select(current.id); };
    s.appendChild(d);
  });
  el('#addSelect').onclick=()=>{ (current.selects ||= []).push({name:'',price:0}); renderTable(); select(current.id); };
}

function dumpJSON(){ el('#json').textContent = JSON.stringify(cards,null,2); }
function downloadJSON(){
  const blob=new Blob([el('#json').textContent],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='datacards.json'; a.click();
  URL.revokeObjectURL(a.href);
}
function addCard(){ const id=Date.now(); cards.push({id,title:"New Data Card",shortDescription:"",description:"",universe:0,baseRate:0,lastUpdate:"",pricing:[],selects:[]}); renderTable(); select(id); }

document.getElementById('add').onclick=()=>{ const id=Date.now(); cards.push({id,title:"New Data Card",shortDescription:"",description:"",universe:0,baseRate:0,lastUpdate:"",pricing:[],selects:[]}); renderTable(); select(id); };
document.getElementById('download').onclick=downloadJSON;

(async function(){
  try{
    const res = await fetch('data/datacards.json',{cache:'no-store'});
    cards = await res.json();
  }catch(e){ cards=[]; }
  renderTable();
  if(cards[0]) select(cards[0].id);
})();
</script>
</body>
</html>
