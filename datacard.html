<!doctype html>
<html lang="en">
<head>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Data Card Details | Allegiance List Marketing</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet"/>
  <style>
    :root { --primary:#0A3D62; --accent:#E67E22; --dark:#1A202C; --light:#F4F7F9; --gray:#64748b; --white:#ffffff; --border:#e2e8f0 }
    body { margin:0; font-family:'Roboto',sans-serif; color:var(--dark); background:var(--light) }
    h1,h2,h3,h4 { font-family:'Montserrat',sans-serif; color:var(--primary) }
    .container { max-width:1200px; margin:0 auto; padding:0 2rem }
    .header { background:var(--white); border-bottom:1px solid var(--border) }
    .nav { display:flex; justify-content:space-between; align-items:center; height:96px }
    .brand img{height:96px;width:auto;display:block}
    .nav-links { display:flex; list-style:none; gap:3rem; margin:0; padding:0 }
    .nav-links a { color:var(--dark); text-decoration:none; font-weight:500 }
    main { padding:40px 0 }
    .breadcrumb { font-size:.9rem; color:var(--gray); margin-bottom:1rem }
    .breadcrumb a { color:var(--primary); text-decoration:none }
    #card-title { font-size:2.4rem; margin-bottom:1rem }
    .datacard-layout { display:grid; grid-template-columns:2fr 1fr; gap:2rem; align-items:flex-start }
    .data-card { background:var(--white); padding:2rem; border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,0.05); border:1px solid var(--border) }
    .data-card h3 { font-size:1.5rem; margin-top:0; margin-bottom:1.2rem; border-bottom:1px solid var(--border); padding-bottom:1rem }
    .stat-block { display:flex; text-align:center; justify-content:space-around; gap:1rem; flex-wrap:wrap }
    .stat-item .value { font-size:2rem; font-weight:700; color:var(--primary) }
    .stat-item .label { font-size:.9rem; color:var(--gray); text-transform:uppercase }
    .data-table { width:100%; border-collapse:collapse }
    .data-table th, .data-table td { padding:.8rem 1rem; text-align:left; border-bottom:1px solid var(--border) }
    .data-table th { color:var(--gray); font-weight:500 }
    .data-table td.price, .data-table td.count { text-align:right; font-variant-numeric:tabular-nums }
    .key-value-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:1.2rem }
    .kv-item .key { font-weight:700; color:var(--gray); font-size:.9rem; display:block }
    .kv-item .value { font-size:1.05rem }
    .btn { background:#0A3D62; color:#fff; border:none; padding:.75rem 1rem; border-radius:8px; font-weight:700; cursor:pointer; text-decoration:none; display:inline-block }
    .btn.alt { background:#334155 }
    .btn.red { background:#DC2626 }
    @media (max-width:980px){ .datacard-layout{ grid-template-columns:1fr } }
  </style>
</head>
<body>
  <header class="header">
    <nav class="nav container">
      <a href="index.html" class="brand"><img src="assets/img/alm-logo.png" alt="Allegiance List Marketing logo"></a>
      <ul class="nav-links">
        <li><a href="index.html#services">Services</a></li>
        <li><a href="marketplace.html">Data Marketplace</a></li>
      </ul>
    </nav>
  </header>
  <main>
    <div class="container">
      <p class="breadcrumb"><a href="marketplace.html">Data Marketplace</a> / <span id="breadcrumb-title">...</span></p>
      <h1 id="card-title">Loadingâ€¦</h1>
      <div class="datacard-layout">
        <div class="main-content">
          <div class="data-card" id="key-stats-card">
            <div class="stat-block">
              <div class="stat-item"><div id="card-universe" class="value">-</div><div class="label">Universe</div></div>
              <div class="stat-item"><div id="card-rate" class="value">-</div><div class="label">Base Rate</div></div>
              <div class="stat-item"><div id="card-updated" class="value">-</div><div class="label">Last Updated</div></div>
            </div>
          </div>
          <div class="data-card"><h3>Description</h3><p id="card-description"></p></div>
          <div class="data-card" id="pricing-card"><h3>Pricing</h3>
            <table class="data-table" id="pricing-table"><thead><tr><th>Segment</th><th>Count</th><th style="text-align:right;">Price per Thousand</th></tr></thead><tbody></tbody></table>
          </div>
          <div class="data-card" id="selects-card"><h3>Optional Selects</h3>
            <table class="data-table" id="selects-table"><thead><tr><th>Select</th><th style="text-align:right;">Price per Thousand</th></tr></thead><tbody></tbody></table>
          </div>
          <div class="data-card"><h3>Audience Profile</h3>
            <div class="key-value-grid">
              <div class="kv-item"><span class="key">Source</span><span id="profile-source" class="value"></span></div>
              <div class="kv-item"><span class="key">Geography</span><span id="profile-geo" class="value"></span></div>
              <div class="kv-item"><span class="key">Male</span><span id="profile-male" class="value"></span></div>
              <div class="kv-item"><span class="key">Female</span><span id="profile-female" class="value"></span></div>
            </div>
          </div>
          <div class="data-card" id="pdf-card" style="display:none"><h3>Reference PDF</h3>
            <p><a id="pdf-link" class="btn" target="_blank" rel="noopener">Open PDF</a></p>
          </div>
        </div>
        <aside class="sidebar">
          <div class="data-card">
            <h3>Actions</h3>
            <p style="font-size:.9rem;color:#64748b;margin-top:-.5rem;margin-bottom:1rem;">Download or request details.</p>
            <button id="download-pdf" class="btn">Download PDF</button>
            <a id="email-btn" class="btn alt" style="margin-left:8px"  href="mailto:megan.com">Email Us</a>
          </div>
        </aside>
      </div>
    </div>
  </main>

  <!-- PDF libs -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.7.1/dist/jspdf.plugin.autotable.min.js"></script>

  <script>
    let currentCard = null;

    // Helper: fetch an image and return dataURL for PDF embedding
    async function toDataURL(url){
      const res = await fetch(url, {cache:'no-store'});
      const blob = await res.blob();
      return await new Promise(resolve => { const fr=new FileReader(); fr.onload=()=>resolve(fr.result); fr.readAsDataURL(blob); });
    }
    function fmt(n){ return (n||0).toLocaleString(); }

    async function generatePDF(card){
      if(!card) return;
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'pt', format:'letter' });
      const pageW = doc.internal.pageSize.getWidth();
      const margin = 48;
      let y = margin;

      // Header/logo
      try {
        const logo = await toDataURL('assets/img/alm-logo.png');
        doc.addImage(logo, 'PNG', margin, y, 120, 90);
      } catch(e) { /* ignore if image fails */ }

      doc.setFont('helvetica', 'bold'); doc.setFontSize(20);
      doc.text(card.title || 'Data Card', margin, y + 110);

      doc.setFont('helvetica', ''); doc.setFontSize(11);
      doc.text('Universe: ' + fmt(card.universe), margin, y + 130);
      doc.text('Base Rate: $' + ((+card.baseRate||0).toFixed(2)) + '/M', margin + 220, y + 130);
      doc.text('Last Updated: ' + (card.lastUpdate||''), margin + 400, y + 130);

      y += 160;

      // Description
      if(card.description){
        doc.setFont('helvetica','bold'); doc.setFontSize(14); doc.text('Description', margin, y);
        y += 14;
        doc.setFont('helvetica',''); doc.setFontSize(11);
        const lines = doc.splitTextToSize(card.description, pageW - margin*2);
        doc.text(lines, margin, y + 10);
        y += 10 + lines.length * 14;
      }

      // Pricing table
      if((card.pricing||[]).length){
        doc.setFont('helvetica','bold'); doc.setFontSize(14); doc.text('Pricing', margin, y + 20);
        y += 24;
        doc.autoTable({
          startY: y,
          margin: { left: margin, right: margin },
          styles: { fontSize: 11 },
          head: [['Segment', 'Count', 'Price/M']],
          body: card.pricing.map(r => [r.segment||'', fmt(r.count||0), '$'+(+r.price||0).toFixed(2)]),
        });
        y = doc.lastAutoTable.finalY + 10;
      }

      // Selects table
      if((card.selects||[]).length){
        doc.setFont('helvetica','bold'); doc.setFontSize(14); doc.text('Optional Selects', margin, y + 20);
        y += 24;
        doc.autoTable({
          startY: y,
          margin: { left: margin, right: margin },
          styles: { fontSize: 11 },
          head: [['Select', 'Price/M']],
          body: card.selects.map(s => [s.name||'', '$'+(+s.price||0).toFixed(2)]),
        });
        y = doc.lastAutoTable.finalY + 10;
      }

      // Audience profile
      const profile = [
        ['Source', card.source||''],
        ['Geography', card.geography||''],
        ['Male', card.genderMale||''],
        ['Female', card.genderFemale||''],
      ].filter(r => r[1]);
      if(profile.length){
        doc.setFont('helvetica','bold'); doc.setFontSize(14); doc.text('Audience Profile', margin, y + 20);
        y += 24;
        doc.autoTable({
          startY: y,
          margin: { left: margin, right: margin },
          styles: { fontSize: 11 },
          head: [['Field', 'Value']],
          body: profile,
        });
        y = doc.lastAutoTable.finalY + 10;
      }

      // Footer
      doc.setDrawColor(200); doc.line(margin, 750, pageW-margin, 750);
      doc.setFont('helvetica',''); doc.setFontSize(9);
      doc.text('Allegiance List Marketing â€” Political Fundraising Excellence', margin, 767);
      doc.text(new Date().toLocaleString(), pageW - margin, 767, { align:'right' });

      doc.save((card.title || 'Data Card') + '.pdf');
    }

    // Page boot
    (async function(){
      const qs = new URLSearchParams(location.search);
      const id = qs.get('id');

      let store=[];
      try { store = await (await fetch('data/datacards.json',{cache:'no-store'})).json(); } catch(e){ store=[]; }
      const card = store.find(c => String(c.id) === String(id));
      currentCard = card;

      if(!card){ document.getElementById('card-title').textContent = "Data Card Not Found"; return; }

      // Fill UI
      document.title = card.title + " | Allegiance List Marketing";
      document.getElementById('breadcrumb-title').textContent = card.title;
      document.getElementById('card-title').textContent = card.title;
      document.getElementById('card-universe').textContent = (card.universe||0).toLocaleString();
      document.getElementById('card-rate').textContent = "$" + (+card.baseRate||0).toFixed(2);
      document.getElementById('card-updated').textContent = (card.lastUpdate||"");
      document.getElementById('card-description').textContent = card.description||"";
      document.getElementById('profile-source').textContent = card.source||"";
      document.getElementById('profile-geo').textContent = card.geography||"";
      document.getElementById('profile-male').textContent = card.genderMale||"";
      document.getElementById('profile-female').textContent = card.genderFemale||"";

      const pb = document.querySelector('#pricing-table tbody'); pb.innerHTML="";
      (card.pricing||[]).forEach(row=>{
        pb.innerHTML += `<tr><td>${row.segment||""}</td><td class="count">${(row.count||0).toLocaleString()}</td><td class="price">$${(+row.price||0).toFixed(2)}</td></tr>`;
      });

      const sb = document.querySelector('#selects-table tbody'); sb.innerHTML="";
      (card.selects||[]).forEach(row=>{
        sb.innerHTML += `<tr><td>${row.name||""}</td><td class="price">+$${(+row.price||0).toFixed(2)}</td></tr>`;
      });

      const email = document.getElementById('email-btn');
      email.href = "mailto:megan.com?subject=" + encodeURIComponent("Data Card Inquiry â€” " + card.title);

      if(card.pdf){
        const pdfCard = document.getElementById('pdf-card');
        pdfCard.style.display = "block";
        const link = document.getElementById('pdf-link');
        link.href = card.pdf;
        link.textContent = "Open " + card.title + " PDF";
      }

      // Wire the Download PDF button
      document.getElementById('download-pdf').addEventListener('click', function(e){
        e.preventDefault(); generatePDF(currentCard);
      });

      // If someone linked with #pdf, auto-generate
      if (location.hash === '#pdf') {
        setTimeout(()=>generatePDF(currentCard), 300);
      }
    })();
  </script>
</body>
<script>
document.addEventListener('DOMContentLoaded', function(){
  var link=document.getElementById('email-btn')||document.querySelector('a[href^="mailto"]');
  if(!link) return;
  var t=document.getElementById('card-title');
  var subj = t ? 'Data Card Inquiry â€” ' + t.textContent.trim() : 'Allegiance List Marketing Inquiry';
  link.setAttribute('href','mailto:megan@allegiancelists.com?subject='+encodeURIComponent(subj)+'&body='+encodeURIComponent(location.href));
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  var link = document.getElementById('email-btn');
  if (!link) return;
  function setLink(){
    var t = document.getElementById('card-title') ? document.getElementById('card-title').textContent.trim() : '';
    var href = 'mailto:megan@allegiancelists.com'
             + '?subject=' + encodeURIComponent('Data Card Inquiry â€” ' + t)
             + '&body='    + encodeURIComponent(location.href);
    link.setAttribute('href', href);
  }
  // run after content loads
  setTimeout(setLink, 400);
});
</script>
</html>
<!-- ALM_MD_V2: Markdown support for data cards -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
(function(){
  function param(n){ return new URLSearchParams(location.search).get(n); }
  const id = param('id');
  if(!id) return;

  fetch('data/datacards.json?v='+Date.now()).then(r=>r.json()).then(arr=>{
    const card = arr.find(c => String(c.card_id) === String(id));
    if(!card || !card.markdown) return;

    // container
    let host = document.getElementById('md-content');
    if(!host){
      host = document.createElement('section');
      host.id = 'md-content';
      host.style.maxWidth = '900px';
      host.style.margin = '24px auto';
      host.style.padding = '0 16px';
      document.body.appendChild(host);
    }

    fetch(card.markdown+'?v='+Date.now())
      .then(r=>r.text())
      .then(md => { host.innerHTML = marked.parse(md); })
      .catch(console.error);
  }).catch(console.error);
})();
</script>
