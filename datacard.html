<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Data Card — Allegiance List Marketing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial;background:#f7f8fb;color:#111}
    .wrap{max-width:900px;margin:24px auto;padding:0 16px}
    .muted{color:#5b6575}
    .pill{display:inline-block;border:1px solid #e1e3ea;border-radius:999px;padding:4px 10px;background:#fafbff;margin-right:6px}
    .top{display:flex;flex-wrap:wrap;align-items:center;gap:8px}
    a.btn{display:inline-block;padding:8px 12px;border-radius:10px;border:1px solid #dfe3ef;background:#fff;text-decoration:none;color:#111;font-weight:600}
    a.btn.primary{background:#C22B2B;color:#fff;border-color:#C22B2B}
    #md-content h1{margin-top:0}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="top"><a href="marketplace.html" class="btn">← Back</a><h1 id="title" style="margin:0;font-size:1.4rem"></h1></div>
    <div id="meta" class="muted" style="margin:10px 0"></div>
    <div id="actions" style="margin:14px 0"></div>
    <section id="md-content"></section>
    <div id="fallback" class="muted" style="display:none;margin-top:16px">No Markdown available for this card.</div>
  </div>

  <script>
  (async function(){
    const id = new URLSearchParams(location.search).get('id');
    const titleEl = document.getElementById('title');
    if(!id){ titleEl.textContent = "Data card not found"; return; }

    const bust = '?v=' + Date.now();
    async function tryJSON(u){
      try{
        const r = await fetch(u,{cache:'no-store'});
        if(!r.ok) return null;
        return await r.json();
      }catch(e){ return null; }
    }

    // Load the single, authoritative data file
    const data = await tryJSON('assets/data/datacards.json'+bust) || [];
    const card = data.find(c => String(c.card_id ?? c.id) === String(id));

    if(!card){ titleEl.textContent = "Data card not found"; return; }

    // Render header/meta
    titleEl.textContent = card.title || "Untitled";
    const u = Number(card.universe_size ?? card.universe ?? 0);
    const r = Number(card.base_rate_per_thousand ?? card.baseRate ?? 0);
    const pills = [];
    pills.push(`<span class="pill">Universe: ${u>0?u.toLocaleString():"n/a"}</span>`);
    pills.push(`<span class="pill">Base: ${r>0?("$"+r.toFixed(2)+"/M"):"call"}</span>`);
    if(card.last_updated || card.lastUpdate) pills.push(`<span class="pill">Updated: ${card.last_updated || card.lastUpdate}</span>`);
    document.getElementById('meta').innerHTML = pills.join(" ");

    // Actions
    const actions = [];
    actions.push(`<a class="btn primary" href="form/request.html?card=${encodeURIComponent(id)}">Request list</a>`);
    if(card.pdf) actions.push(`<a class="btn" target="_blank" href="${card.pdf}">Download PDF</a>`);
    document.getElementById('actions').innerHTML = actions.join(" ");

    // Markdown render (if present)
    if(card.markdown && card.markdown.endsWith('.md')){
      try{
        const md = await fetch(card.markdown + bust, {cache:'no-store'}).then(r=>r.text());
        document.getElementById('md-content').innerHTML = marked.parse(md);
      }catch(e){ document.getElementById('fallback').style.display = "block"; }
    }else{
      document.getElementById('fallback').style.display = "block";
    }
  })();
  </script>
</body>
</html>
